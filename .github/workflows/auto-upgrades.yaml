name: Automated Falcon Upgrades

on:
  workflow_dispatch:
    inputs:
      kac-version:
        description: 'KAC version'
        required: false
      sensor-version:
        description: 'Sensor version'
        required: false
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - 'dev & nonprod'
          - production

jobs:
  # This job creates a pull request for dev upgrades
  create-dev-pr:
    runs-on: ubuntu-latest
    if: inputs.environment == 'dev & nonprod' && (inputs.kac-version || inputs.sensor-version)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Update download-any-image.yaml (KAC)
        if: inputs.kac-version
        run: |
          echo "Updating download-any-image.yaml with new KAC version..."
          cat "download-any-image.yaml"
          sed -i '/imagename: falcon-kac/{n;s|imagetag: .*|imagetag: "${{ inputs.kac-version }}"|;}' download-any-image.yaml
          cat "download-any-image.yaml"
          echo "Updated download-any-image.yaml with new KAC version."

      - name: Update download-any-image.yaml (Sensor)
        if: inputs.sensor-version
        run: |
          echo "Updating download-any-image.yaml with new Sensor version..."
          cat "download-any-image.yaml"
          sed -i '/imagename: falcon-sensor/{n;s|imagetag: .*|imagetag: "${{ inputs.sensor-version }}"|;}' download-any-image.yaml
          cat "download-any-image.yaml"
          echo "Updated download-any-image.yaml with new Sensor version."

      - name: Update KAC Deployment
        if: inputs.kac-version
        run: |
          kac_template='apiVersion: builtin
          kind: PatchTransformer
          metadata:
            name: falcon-kac-deploy
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
            name: falcon-kac-deploy
            namespace: flux-system
          patch: |-
            - op: add
              path: /spec/patches/-
              value:
                target:
                  group: helm.toolkit.fluxcd.io
                  kind: HelmRelease
                  name: falcon-kac
                  namespace: falcon-kac-system
                patch: |-
                  - op: replace
                    path: /spec/values/image/tag
                    value: "${{ inputs.kac-version }}"'
          echo "Applying KAC template"
          echo "$kac_template" > config/base/cluster/global/gke-pe-dev/transformers/kac-transformer.yaml
          sed -i -z 's|transformers:\n|transformers:\n- transformers/falcon-kac.yaml|' config/base/cluster/global/gke-pe-dev/kustomization.yaml
          echo "KAC version: ${{ inputs.kac-version }}"

      - name: Update Sensor Deployment
        if: inputs.sensor-version
        run: |
          echo "Updating Sensor deployment with new version..."
          sed -i -z 's|#version.*|        - op: replace\n          path: /spec/values/node/image/tag\n          value: "${{ inputs.sensor-version }}"|' config/base/cluster/global/gke-pe-dev/transformers/falcon-sensor.yaml
          echo "Sensor version updated to ${{ inputs.sensor-version }}."

      # - name: Create Pull Request
      #   uses: peter-evans/create-pull-request@v7
      #   with:
      #     title: "Upgrade KAC and/or Sensor Dev"
      #     body: |
      #       Upgrade KAC to ${{ inputs.kac-version }} and Sensor to ${{ inputs.sensor-version }}.
      #     branch: "upgrade-${{ github.run_id }}" # Unique branch name
      #     commit-message: "Upgrade KAC and/or Sensor Dev"

  # This job creates a pull request for nonprod upgrades
  create-nonprod-pr:
    runs-on: ubuntu-latest
    if: inputs.environment == 'dev & nonprod' && (inputs.kac-version || inputs.sensor-version)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to allow for accurate branch creation
      - name: Update KAC Deployment for nonprod
        if: inputs.kac-version
        run: |
          kac_template='apiVersion: builtin
          kind: PatchTransformer
          metadata:
            name: falcon-kac-deploy
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
            name: falcon-kac-deploy
            namespace: flux-system
          patch: |-
            - op: add
              path: /spec/patches/-
              value:
                target:
                  group: helm.toolkit.fluxcd.io
                  kind: HelmRelease
                  name: falcon-kac
                  namespace: falcon-kac-system
                patch: |-
                  - op: replace
                    path: /spec/values/image/tag
                    value: "${{ inputs.kac-version }}"'
          echo "Applying KAC template..."
          echo "$kac_template" > config/base/cluster/global/stable-nonprod/transformers/kac-transformer.yaml
          echo "KAC version: ${{ inputs.kac-version }}"

      - name: Update Sensor Deployment for nonprod
        if: inputs.sensor-version
        run: |
          echo "Updating Sensor deployment with new version..."
          sed -i -z 's|#version.*|        - op: replace\n          path: /spec/values/node/image/tag\n          value: "${{ inputs.sensor-version }}"|' config/base/cluster/global/stable-nonprod/transformers/falcon-sensor.yaml
          echo "Sensor version updated to ${{ inputs.sensor-version }}."

  #     - name: Create Pull Request
  #       uses: peter-evans/create-pull-request@v7
  #       with:
  #         title: "Upgrade KAC and/or Sensor Nonprod"
  #         body: |
  #           Upgrade KAC to ${{ inputs.kac-version }} and Sensor to ${{ inputs.sensor-version }}.
  #         branch: "upgrade-${{ github.run_id }}" # Unique branch name
  #         commit-message: "Upgrade KAC and/or Sensor Nonprod"

  # This job creates a pull request for prod upgrades
  create-prod-pr:
    runs-on: ubuntu-latest
    if: inputs.environment == 'production' && (inputs.kac-version || inputs.sensor-version)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to allow for accurate branch creation
      - name: Remove Dev and Nonprod KAC Transformation
        if: inputs.kac-version
        run: |
          echo "Removing dev and nonprod KAC transformations..."
          rm -f config/base/cluster/global/gke-pe-dev/transformers/falcon-kac.yaml
          rm -f config/base/cluster/global/stable-nonprod/transformers/falcon-kac.yaml
          sed -i '/- transformers\/falcon-kac.yaml/d' config/base/cluster/global/gke-pe-dev/kustomization.yaml config/base/cluster/global/stable-nonprod/kustomization.yaml

      - name: Remove Dev and Nonprod Sensor Transformation
        if: inputs.sensor-version
        run: |
          echo "Removing Sensor version..."
          sed -i -z 's|        - op: replace\n          path: /spec/values/node/image/tag\n          value:.*|#version|' config/base/cluster/global/gke-pe-dev/transformers/falcon-sensor.yaml config/base/cluster/global/stable-nonprod/transformers/falcon-sensor.yaml

      - name: Update KAC version for prod
        if: inputs.kac-version
        run: |
          sed -i 's|tag: .*"|tag: "${{ inputs.kac-version }}"|gm' config/base/applications/falcon-kac/v1/deploy/falcon-kac.yaml
      - name: Update Sensor version for prod
        if: inputs.sensor-version
        run: |
          sed -i 's|tag: .*"|tag: "${{ inputs.sensor-version }}"|gm' config/base/applications/falcon-sensor/v1/deploy/falcon-sensor.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          title: "Upgrade KAC and/or Sensor prod"
          body: |
            Upgrade KAC to ${{ inputs.kac-version }} and Sensor to ${{ inputs.sensor-version }}.
          branch: "upgrade-${{ github.run_id }}" # Unique branch name
          commit-message: "Upgrade KAC and/or Sensor prod"